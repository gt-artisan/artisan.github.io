name: Sync BibTeX → YAML (Publications)

on:
  push:
    paths:
      - "_data/publications.bib"
  workflow_dispatch:

permissions:
  contents: write   # allow this workflow to commit the generated YAML back
  # all other scopes default to 'none' for least-privilege

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install converters
        run: |
          python -m pip install --upgrade pip
          pip install bibtexparser pyyaml

      - name: Convert _data/publications.bib → _data/publications.yml
        run: |
          python - << 'PYCODE'
          import bibtexparser, yaml, re

          def split_authors(s):
              # BibTeX 'and'-separated author list → Python list
              parts = [p.strip() for p in re.split(r'\s+and\s+', s)] if s else []
              return [p for p in parts if p]

          with open("_data/publications.bib", "r", encoding="utf-8") as f:
              bib = bibtexparser.load(f)

          out = []
          for e in bib.entries:
              item = {}
              item["id"]      = e.get("ID")
              item["type"]    = e.get("ENTRYTYPE")
              item["title"]   = e.get("title")
              item["year"]    = int(e["year"]) if e.get("year","").isdigit() else e.get("year")
              item["authors"] = split_authors(e.get("author"))
              # normalize venue
              venue = e.get("journal") or e.get("booktitle")
              if venue: item["venue"] = venue
              # optional bits
              for k in ["doi","url","pdf","arxiv"]:
                  if e.get(k): item[k] = e.get(k)
              out.append(item)

          with open("_data/publications.yml", "w", encoding="utf-8") as g:
              yaml.safe_dump(out, g, sort_keys=False, allow_unicode=True)
          PYCODE

      - name: Commit & push YAML (if changed)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add _data/publications.yml
          git commit -m "ci(pub): auto-update _data/publications.yml" || echo "No changes to commit"
          git push